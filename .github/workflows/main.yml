name: VPS Gratisan Gabut
on:
  workflow_dispatch: # Biar bisa diklik Start manual

jobs:
  start-vps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. SETUP & JALANIN DOCKER TERMINAL (ttyd)
      - name: Start Terminal Container
        run: |
          # Kita pake image ttyd yang enteng (Alpine Linux)
          # -p 7681:7681 = Buka port web terminal
          # -v ${{ github.workspace }}:/root/project = Biar file project lo masuk ke dalem container
          # -c admin:password123 = PASSWORD LOGIN (Ganti ini biar ga dihack orang!)
          
          docker run -d --name vps-gabut \
            -p 7681:7681 \
            -v ${{ github.workspace }}:/root/project \
            tsl0922/ttyd:alpine \
            ttyd -W -c admin:password123 sh

      # 2. INSTALL TOOLS DI DALEM CONTAINER (Biar ga kosongan)
      - name: Install Tools (Bash, Git, Curl, Node)
        run: |
          echo "Lagi install tools, tunggu bentar..."
          # Update repo alpine & install bash, git, curl, nano, nodejs
          docker exec -u 0 vps-gabut apk update
          docker exec -u 0 vps-gabut apk add bash git curl nano nodejs npm
          
          # Ganti shell default jadi bash biar enak
          docker exec -u 0 vps-gabut sed -i 's|/bin/sh|/bin/bash|g' /etc/passwd
          echo "Tools siap! Terminal udah canggih sekarang."

      # 3. KONEK KE CLOUDFLARE TUNNEL
      - name: Start Cloudflare Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          # Konek ke localhost:7681 (Port terminal container tadi)
          sudo cloudflared service install ${{ secrets.CF_TOKEN }}
          sudo service cloudflared start

      # 4. TUNGU 5.5 JAM (LOOPING)
      - name: Server Online - Jangan di Close Tab-nya
        run: |
          echo "=============================================="
          echo "VPS LO UDAH ONLINE, BOS!"
          echo "Buka domain lo di browser."
          echo "Login pake User: admin | Pass: password123"
          echo "=============================================="
          echo "Gw bakal tidur 5 jam 30 menit..."
          sleep 19800
