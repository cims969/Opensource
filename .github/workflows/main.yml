name: n8n Auto Login (CF Token Secret)
on: 
  workflow_dispatch:

jobs:
  deploy-n8n:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: 1. Start n8n Docker
        run: |
          echo "Gas nyalain n8n..."
          # Jalanin n8n di background
          docker run -d \
            --name n8n \
            -p 5678:5678 \
            -e N8N_SECURE_COOKIE=false \
            -e N8N_PROTOCOL=https \
            n8nio/n8n:latest
          
          echo "Tidur 30 detik buat init DB..."
          sleep 30

      - name: 2. Auto Setup Akun (Hardcoded)
        run: |
          echo "Inject akun admin..."
          # Email & Pass langsung ditulis disini (Hardcode)
          # Command pake versi baru v1+
          docker exec n8n n8n user:management:user:create \
            --email "admin@ngadimin.com" \
            --password "Juragan123!" \
            --firstName "Admin" \
            --lastName "Ganteng"

      - name: 3. Start Cloudflare Tunnel
        run: |
          echo "Konek ke Cloudflare..."
          # Token tetep ambil dari Secret yang udah lu punya
          docker run \
            --name cloudflared \
            --network host \
            cloudflare/cloudflared:latest \
            tunnel --no-autoupdate run --token ${{ secrets.CF_TOKEN }}
