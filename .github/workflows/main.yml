name: n8n Korea Server Fix
on: 
  workflow_dispatch:

jobs:
  deploy-n8n:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: 1. Start n8n (Server Korea)
        run: |
          echo "Gas nyalain n8n..."
          echo "Konek ke Region: Korea (ap-northeast-2)"
          
          # Kita pake CONNECTION STRING dari Secret
          docker run -d \
            --name n8n \
            -p 5678:5678 \
            -e N8N_SECURE_COOKIE=false \
            -e N8N_PROTOCOL=https \
            -e N8N_ENCRYPTION_KEY="kuncirahasiajuragan123" \
            -e DB_TYPE=postgresdb \
            -e DB_POSTGRESDB_CONNECTION_STRING="${{ secrets.DB_URL }}" \
            n8nio/n8n:latest
          
          echo "Lagi inisialisasi Database (Tunggu 20 detik)..."
          sleep 20

      - name: 2. CEK STATUS (Jaga-jaga)
        run: |
          echo "=== APAKAH N8N HIDUP? ==="
          docker ps
          echo "=== LOG TERAKHIR ==="
          docker logs n8n --tail 20

      - name: 3. Start Cloudflare Tunnel
        run: |
          echo "Online-kan..."
          # Pastikan service tunnel di dashboard Cloudflare: HTTP -> 127.0.0.1:5678
          docker run \
            --name cloudflared \
            --network host \
            cloudflare/cloudflared:latest \
            tunnel --no-autoupdate run --token ${{ secrets.CF_TOKEN }}
